{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
          <i class="fas fa-database me-2"></i>Database Viewer
        </h2>
        <div>
          <span class="badge bg-primary me-2">Users: {{ user_count }}</span>
          <span class="badge bg-success">Medical Records: {{ medical_count }}</span>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>Registered Users
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Date of Birth</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.id }}</td>
                  <td>{{ user.username }}</td>
                  <td>{{ user.uname }}</td>
                  <td>{{ user.lname }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.phone }}</td>
                  <td>{{ user.date }}</td>
                  <td>{{ user.address }}</td>
                  <td>
                    <a href="{{ url_for('edit_user', id=user.id) }}" class="btn btn-sm btn-warning">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_user', id=user.id) }}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this user?')">
                      <i class="fas fa-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Medical Records Table -->
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-notes-medical me-2"></i>Medical Records
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>User ID</th>
                  <th>Allergies</th>
                  <th>Medications</th>
                  <th>Surgeries</th>
                  <th>Blood Group</th>
                  <th>Chronic Conditions</th>
                  <th>Emergency Contact</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for record in medical_records %}
                <tr>
                  <td>{{ record.id }}</td>
                  <td>{{ record.user_id }}</td>
                  <td>{{ record.allergies or 'N/A' }}</td>
                  <td>{{ record.medications or 'N/A' }}</td>
                  <td>{{ record.surgeries or 'N/A' }}</td>
                  <td>{{ record.blood_group or 'N/A' }}</td>
                  <td>{{ record.chronic_conditions or 'N/A' }}</td>
                  <td>{{ record.emergency_contact or 'N/A' }}</td>
                  <td>
                    <a href="{{ url_for('update_medical', id=record.id) }}" class="btn btn-sm btn-warning">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_medical', id=record.id) }}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this medical record?')">
                      <i class="fas fa-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Export Options -->
      <div class="card shadow mt-4">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-download me-2"></i>Export Options
          </h5>
          <div class="row">
            <div class="col-md-6">
              <button class="btn btn-primary w-100" onclick="exportData('users')">
                <i class="fas fa-file-csv me-2"></i>Export Users as CSV
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-success w-100" onclick="exportData('medical')">
                <i class="fas fa-file-csv me-2"></i>Export Medical Records as CSV
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function exportData(type) {
  let table = type === 'users' ? 
    document.querySelector('table:first-of-type') : 
    document.querySelector('table:last-of-type');
  
  let csv = [];
  let rows = table.querySelectorAll('tr');
  
  for (let i = 0; i < rows.length; i++) {
    let row = [], cols = rows[i].querySelectorAll('td, th');
    
    for (let j = 0; j < cols.length - 1; j++) { // Skip last column (Actions)
      row.push(cols[j].innerText);
    }
    csv.push(row.join(','));
  }
  
  let csvContent = csv.join('\n');
  let blob = new Blob([csvContent], { type: 'text/csv' });
  let url = window.URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = `${type}_data.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
}
</script>

<style>
.table-responsive {
  max-height: 400px;
  overflow-y: auto;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 123, 255, 0.1);
}

.card {
  border: none;
  border-radius: 10px;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}
